<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Android Audio系统分析（一）概览"><meta name="keywords" content="Android Source,Android System,Audio"><meta name="author" content="二十I邊界"><meta name="copyright" content="二十I邊界"><title>Android Audio系统分析（一）概览 | 二十I邊界</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.2'
} </script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="二十I邊界" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A8%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">初始化动作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">写数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#track-sharedBuffer-pointer-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.</span> <span class="toc-text">track-&gt;sharedBuffer()-&gt;pointer()是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-To-Play"><span class="toc-number">4.</span> <span class="toc-text">How To Play</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">二十I邊界</div><div class="author-info__description text-center">Get busy living or get busy dying!</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/xuie0000">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">50</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">66</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://androidweekly.net/">ANDROID WEEKLY</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://toutiao.io/">开发者头条</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.androidweekly.cn/">开发技术周报</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://github.com/xuie0000/xuie0000.github.io/assets/8099426/9f0744ca-d4e6-48f6-91fd-aefec139e021)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">二十I邊界</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/categories/Android">Android</a><a class="site-page" href="/categories/Spring-Boot">Spring</a><a class="site-page" href="/categories/随想">Other</a><a class="site-page" href="/tags">Tags</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Android Audio系统分析（一）概览</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-10-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>文章分析是从项目<a target="_blank" rel="noopener" href="https://github.com/piterwilson/MP3StreamPlayer">MP3StreamPlayer</a>开始跑流程分析来的，没错，App Demo就是下载这个开始分析来的，手头有源码的自己也去下载一份体验一把吧～～</p>
<span id="more"></span>

<h2 id="初始化动作"><a href="#初始化动作" class="headerlink" title="初始化动作"></a>初始化动作</h2><blockquote>
<p>App代码</p>
</blockquote>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">audioTrack = <span class="keyword">new</span> AudioTrack(</span><br><span class="line">        AudioManager.STREAM_MUSIC,</span><br><span class="line"><span class="built_in">        sampleRate,</span></span><br><span class="line">        AudioFormat.CHANNEL_OUT_STEREO,</span><br><span class="line">        AudioFormat.ENCODING_PCM_16BIT,</span><br><span class="line">        AudioTrack.getMinBufferSize(</span><br><span class="line"><span class="built_in">                sampleRate,</span></span><br><span class="line">                AudioFormat.CHANNEL_OUT_STEREO,</span><br><span class="line">                AudioFormat.ENCODING_PCM_16BIT</span><br><span class="line">        ),</span><br><span class="line">        AudioTrack.MODE_STREAM</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;base&#x2F;media&#x2F;java&#x2F;android&#x2F;media&#x2F;AudioTrack.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AudioTrack</span><span class="params">(AudioAttributes attributes, AudioFormat format, <span class="type">int</span> bufferSizeInBytes,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> mode, <span class="type">int</span> sessionId)</span></span><br><span class="line">                <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> ServiceManager.getService(Context.APP_OPS_SERVICE);</span><br><span class="line">    mAppOps = IAppOpsService.Stub.asInterface(b);</span><br><span class="line"></span><br><span class="line">    mAttributes = (<span class="keyword">new</span> <span class="title class_">AudioAttributes</span>.Builder(attributes).build());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// native initialization 这里进行native的一些初始化，包括`native AutioTrack`</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">initResult</span> <span class="operator">=</span> native_setup(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;AudioTrack&gt;(<span class="built_in">this</span>), mAttributes,</span><br><span class="line">            mSampleRate, mChannels, mAudioFormat,</span><br><span class="line">            mNativeBufferSizeInBytes, mDataLoadMode, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;android_media_AudioTrack.cpp</p>
</blockquote>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> jint</span><br><span class="line">android_media_AudioTrack_setup(JNIEnv *env, jobject thiz, jobject weak_this,</span><br><span class="line">        jobject jaa,</span><br><span class="line">        jint sampleRateInHertz, jint javaChannelMask,</span><br><span class="line">        jint audioFormat, jint buffSizeInBytes, jint memoryMode, jintArray jSession) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the native AudioTrack object</span></span><br><span class="line">    <span class="comment">// 创建native AudioTrack对象</span></span><br><span class="line">    sp&lt;AudioTrack&gt; lpTrack = <span class="keyword">new</span> AudioTrack();</span><br><span class="line"></span><br><span class="line">    AudioTrackJniStorage* lpJniStorage = <span class="keyword">new</span> AudioTrackJniStorage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (memoryMode) &#123;</span><br><span class="line">    <span class="comment">// lpTrack进行初始化动作</span></span><br><span class="line">    <span class="keyword">case</span> MODE_STATIC:</span><br><span class="line">        <span class="comment">// AudioTrack is using shared memory</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!lpJniStorage-&gt;allocSharedMem(buffSizeInBytes)) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;Error creating AudioTrack in static mode: error creating mem heap base&quot;</span>);</span><br><span class="line">            goto native_init_failure;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = lpTrack-&gt;set(</span><br><span class="line">                AUDIO_STREAM_DEFAULT,<span class="comment">// stream type, but more info conveyed in paa (last argument)</span></span><br><span class="line">                sampleRateInHertz,</span><br><span class="line">                format,<span class="comment">// word length, PCM</span></span><br><span class="line">                nativeChannelMask,</span><br><span class="line">                frameCount,</span><br><span class="line">                AUDIO_OUTPUT_FLAG_NONE,</span><br><span class="line">                audioCallback, &amp;(lpJniStorage-&gt;mCallbackData),<span class="comment">//callback, callback data (user));</span></span><br><span class="line">                <span class="number">0</span>,<span class="comment">// notificationFrames == 0 since not using EVENT_MORE_DATA to feed the AudioTrack</span></span><br><span class="line">                lpJniStorage-&gt;mMemBase,<span class="comment">// shared mem</span></span><br><span class="line">                <span class="keyword">true</span>,<span class="comment">// thread can call Java</span></span><br><span class="line">                sessionId,<span class="comment">// audio session ID</span></span><br><span class="line">                AudioTrack::TRANSFER_SHARED,</span><br><span class="line">                NULL,                         <span class="comment">// default offloadInfo</span></span><br><span class="line">                <span class="number">-1</span>, <span class="number">-1</span>,                       <span class="comment">// default uid, pid values</span></span><br><span class="line">                paa);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里将lpTrack被指向&quot;nativeTrackInJavaObj&quot;</span></span><br><span class="line">    setAudioTrack(env, thiz, lpTrack);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里大致就是应用层创建了一个音频对象，最终是指向了native AudioTrack（就是AudioTrack.cpp初始了），要处理的事件都会跑向了它</p>
<h2 id="写数据"><a href="#写数据" class="headerlink" title="写数据"></a>写数据</h2><blockquote>
<p>App代码</p>
</blockquote>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">audioTrack.<span class="built_in">write</span>(chunk,<span class="number">0</span>,chunk.<span class="built_in">length</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;base&#x2F;media&#x2F;java&#x2F;android&#x2F;media&#x2F;AudioTrack.java</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">int</span> <span class="title">write</span><span class="params">(<span class="type">byte</span>[] audioData, <span class="type">int</span> offsetInBytes, <span class="type">int</span> sizeInBytes)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">native_write_byte</span>(audioData, offsetInBytes, sizeInBytes, mAudioFormat,</span><br><span class="line">            <span class="literal">true</span> <span class="comment">/*isBlocking*/</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;android_media_AudioTrack.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> jint <span class="title">android_media_AudioTrack_write_byte</span><span class="params">(JNIEnv *env,  jobject thiz,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  jbyteArray javaAudioData,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  jint offsetInBytes, jint sizeInBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  jint javaAudioFormat,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  jboolean isWriteBlocking)</span> </span>&#123;</span><br><span class="line">    sp&lt;AudioTrack&gt; lpTrack = <span class="built_in">getAudioTrack</span>(env, thiz);</span><br><span class="line"></span><br><span class="line">    jint written = <span class="built_in">writeToTrack</span>(lpTrack, javaAudioFormat, cAudioData, offsetInBytes, sizeInBytes,</span><br><span class="line">            isWriteBlocking == JNI_TRUE <span class="comment">/* blocking */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里从Java层的`AudioTrack`获取了&quot;nativeTrackInJavaObj&quot;的地址（native AudioTrack就是在本文件[android_media_AudioTrack.cpp]的setup里初始化的），直接强转为native AudioTrack</span></span><br><span class="line"><span class="comment">// 源码里好些喜欢用这种方式留个指针拿来用</span></span><br><span class="line"><span class="function"><span class="type">static</span> sp&lt;AudioTrack&gt; <span class="title">getAudioTrack</span><span class="params">(JNIEnv* env, jobject thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">l</span><span class="params">(sLock)</span></span>;</span><br><span class="line">    AudioTrack* <span class="type">const</span> at =</span><br><span class="line">            (AudioTrack*)env-&gt;<span class="built_in">GetLongField</span>(thiz, javaAudioTrackFields.nativeTrackInJavaObj);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sp</span>&lt;AudioTrack&gt;(at);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">writeToTrack</span><span class="params">(<span class="type">const</span> sp&lt;AudioTrack&gt;&amp; track, jint audioFormat, <span class="type">const</span> jbyte* data,</span></span></span><br><span class="line"><span class="params"><span class="function">                  jint offsetInBytes, jint sizeInBytes, <span class="type">bool</span> blocking = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (format) &#123;</span><br><span class="line">        <span class="keyword">case</span> AUDIO_FORMAT_PCM_16_BIT: &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(track-&gt;<span class="built_in">sharedBuffer</span>()-&gt;<span class="built_in">pointer</span>(), data + offsetInBytes, sizeInBytes);</span><br><span class="line">            written = sizeInBytes;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从<code>writeToTrack</code>函数可以看到，是将数据写入了native AudioTrack的共享内存里了</p>
<h2 id="track-sharedBuffer-pointer-是什么"><a href="#track-sharedBuffer-pointer-是什么" class="headerlink" title="track-&gt;sharedBuffer()-&gt;pointer()是什么"></a>track-&gt;sharedBuffer()-&gt;pointer()是什么</h2><blockquote>
<p>frameworks&#x2F;av&#x2F;include&#x2F;media&#x2F;AudioTrack.h</p>
</blockquote>
<p><code>track</code>是native AudioTrack, <code>sharedBuffer</code>是<code>sp&lt;IMemory&gt; sharedBuffer() const &#123; return mSharedBuffer; &#125;</code></p>
<blockquote>
<p>frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;IMemory.cpp</p>
</blockquote>
<p><code>pointer</code>是</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* IMemory::pointer() <span class="keyword">const</span> &#123;</span><br><span class="line">    ssize_t offset;</span><br><span class="line">    sp&lt;IMemoryHeap&gt; heap = getMemory(&amp;offset);</span><br><span class="line">    <span class="keyword">void</span>* <span class="keyword">const</span> <span class="keyword">base</span> = heap!=<span class="number">0</span> ? heap-&gt;<span class="keyword">base</span>() : MAP_FAILED;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">base</span> == MAP_FAILED)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> static_cast&lt;char*&gt;(<span class="keyword">base</span>) + offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段是看共享内存，是个Binder，那感觉放心多了，不会那种太无头序，关于<code>Binder</code>网上很多文章，可以自行参考</p>
<p>然后我们跟踪这个<code>mSharedBuffer</code>，发现它是在native AudioTrack时被赋值的</p>
<blockquote>
<p>frameworks&#x2F;av&#x2F;media&#x2F;libmedia&#x2F;AudioTrack.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AudioTrack::set</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_stream_type_t</span> streamType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> sampleRate,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> frameCount,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_output_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">callback_t</span> cbf,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* user,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> notificationFrames,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">bool</span> threadCanCallJava,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> sessionId,</span></span></span><br><span class="line"><span class="params"><span class="function">        transfer_type transferType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">audio_offload_info_t</span> *offloadInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> uid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">pid_t</span> pid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">audio_attributes_t</span>* pAttributes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mSharedBuffer = sharedBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>set</code>方法是不是眼熟，就是上面<code>android_media_AudioTrack.cpp</code>里的<code>android_media_AudioTrack_setup</code>方法中的初始化时有调用，也就是说共享内存是在初始化时就已经添加好了，最终，mSharedBuffer的大小是<code>mSharedBuffer == AudioTrack.getMinBufferSize()</code>，APP初始AudioTrack时增加，内存大小就成动态变更的了</p>
<p>继续跟踪<code>mSharedBuffer</code></p>
<blockquote>
<p>frameworks&#x2F;av&#x2F;media&#x2F;libmedia&#x2F;AudioTrack.cpp</p>
</blockquote>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">status_t AudioTrack::createTrack_l()</span><br><span class="line">&#123;</span><br><span class="line">    const sp&lt;IAudioFlinger&gt;<span class="meta">&amp; audioFlinger = AudioSystem::get_audio_flinger();</span></span><br><span class="line"></span><br><span class="line">    sp&lt;IAudioTrack&gt; track = audioFlinger-&gt;createTrack(streamType,</span><br><span class="line">                                                      mSampleRate,</span><br><span class="line">                                                      <span class="comment">// AudioFlinger only sees 16-bit PCM</span></span><br><span class="line">                                                      mFormat == AUDIO_FORMAT_PCM_8_BIT <span class="meta">&amp;&amp;</span></span><br><span class="line">                                                          !(mFlags <span class="meta">&amp; AUDIO_OUTPUT_FLAG_DIRECT) ?</span></span><br><span class="line">                                                              AUDIO_FORMAT_PCM_16_BIT : mFormat,</span><br><span class="line">                                                      mChannelMask,</span><br><span class="line">                                                      <span class="meta">&amp;temp,</span></span><br><span class="line">                                                      <span class="meta">&amp;trackFlags,</span></span><br><span class="line">                                                      mSharedBuffer,</span><br><span class="line">                                                      output,</span><br><span class="line">                                                      tid,</span><br><span class="line">                                                      <span class="meta">&amp;mSessionId,</span></span><br><span class="line">                                                      mClientUid,</span><br><span class="line">                                                      <span class="meta">&amp;status);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;av&#x2F;media&#x2F;libmedia&#x2F;AudioSystem.cpp</p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const <span class="built_in">sp</span>&lt;IAudioFlinger&gt; AudioSystem::get_audio_flinger()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">sp</span>&lt;IAudioFlinger&gt; af;</span><br><span class="line">    <span class="built_in">sp</span>&lt;AudioFlingerClient&gt; afc;</span><br><span class="line">    &#123;</span><br><span class="line"><span class="symbol">        Mutex:</span>:Autolock _l(gLock);</span><br><span class="line">        if (gAudioFlinger == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">sp</span>&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">            <span class="built_in">sp</span>&lt;IBinder&gt; <span class="keyword">binder;</span></span><br><span class="line"><span class="keyword"></span>            do &#123;</span><br><span class="line">                <span class="keyword">binder </span>= sm-&gt;getService(String16(<span class="string">&quot;media.audio_flinger&quot;</span>));</span><br><span class="line">                if (<span class="keyword">binder </span>!= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"></span>                ALOGW(<span class="string">&quot;AudioFlinger not published, waiting...&quot;</span>);</span><br><span class="line">                usleep(<span class="number">500000</span>)<span class="comment">; // 0.5 s</span></span><br><span class="line">            &#125; while (true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;AudioFlinger.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IAudioTrack&gt; <span class="title">AudioFlinger::createTrack</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_stream_type_t</span> streamType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> sampleRate,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> *frameCount,</span></span></span><br><span class="line"><span class="params"><span class="function">        IAudioFlinger::<span class="type">track_flags_t</span> *flags,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_io_handle_t</span> output,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">pid_t</span> tid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> *sessionId,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> clientUid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">status_t</span> *status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;PlaybackThread::Track&gt; track;</span><br><span class="line">    PlaybackThread *thread = <span class="built_in">checkPlaybackThread_l</span>(output);</span><br><span class="line">        track = thread-&gt;<span class="built_in">createTrack_l</span>(client, streamType, sampleRate, format,</span><br><span class="line">                channelMask, frameCount, sharedBuffer, lSessionId, flags, tid, clientUid, &amp;lStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;Threads.cpp</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;AudioFlinger::PlaybackThread::Track&gt; AudioFlinger::PlaybackThread::<span class="built_in">createTrack_l</span>(</span><br><span class="line">        <span class="type">const</span> sp&lt;AudioFlinger::<span class="built_in">Client</span>&gt;&amp; client,</span><br><span class="line">        <span class="type">audio_stream_type_t</span> streamType,</span><br><span class="line">        <span class="type">uint32_t</span> sampleRate,</span><br><span class="line">        <span class="type">audio_format_t</span> format,</span><br><span class="line">        <span class="type">audio_channel_mask_t</span> channelMask,</span><br><span class="line">        <span class="type">size_t</span> *pFrameCount,</span><br><span class="line">        <span class="type">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">        <span class="type">int</span> sessionId,</span><br><span class="line">        IAudioFlinger::<span class="type">track_flags_t</span> *flags,</span><br><span class="line">        <span class="type">pid_t</span> tid,</span><br><span class="line">        <span class="type">int</span> uid,</span><br><span class="line">        <span class="type">status_t</span> *status)</span><br><span class="line">&#123;</span><br><span class="line">            <span class="keyword">if</span> (!isTimed) &#123;</span><br><span class="line">                track = <span class="keyword">new</span> <span class="built_in">Track</span>(<span class="keyword">this</span>, client, streamType, sampleRate, format,</span><br><span class="line">                                  channelMask, frameCount, <span class="literal">NULL</span>, sharedBuffer,</span><br><span class="line">                                  sessionId, uid, *flags, TrackBase::TYPE_DEFAULT);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                track = TimedTrack::<span class="built_in">create</span>(<span class="keyword">this</span>, client, streamType, sampleRate, format,</span><br><span class="line">                        channelMask, frameCount, sharedBuffer, sessionId, uid);</span><br><span class="line">            &#125;</span><br><span class="line">            mTracks.<span class="built_in">add</span>(track);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;Track.cpp</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">AudioFlinger::PlaybackThread::Track::<span class="built_in">Track</span>(</span><br><span class="line">            PlaybackThread *thread,</span><br><span class="line">            <span class="type">const</span> sp&lt;<span class="built_in">Client</span>&gt;&amp; client,</span><br><span class="line">            <span class="type">audio_stream_type_t</span> streamType,</span><br><span class="line">            <span class="type">uint32_t</span> sampleRate,</span><br><span class="line">            <span class="type">audio_format_t</span> format,</span><br><span class="line">            <span class="type">audio_channel_mask_t</span> channelMask,</span><br><span class="line">            <span class="type">size_t</span> frameCount,</span><br><span class="line">            <span class="type">void</span> *buffer,</span><br><span class="line">            <span class="type">const</span> sp&lt;IMemory&gt;&amp; sharedBuffer,</span><br><span class="line">            <span class="type">int</span> sessionId,</span><br><span class="line">            <span class="type">int</span> uid,</span><br><span class="line">            IAudioFlinger::<span class="type">track_flags_t</span> flags,</span><br><span class="line">            track_type type)</span><br><span class="line">    :   <span class="built_in">TrackBase</span>(thread, client, sampleRate, format, channelMask, frameCount,</span><br><span class="line">                  (sharedBuffer != <span class="number">0</span>) ? sharedBuffer-&gt;<span class="built_in">pointer</span>() : buffer,</span><br><span class="line">                  sessionId, uid, flags, <span class="literal">true</span> <span class="comment">/*isOut*/</span>,</span><br><span class="line">                  (type == TYPE_PATCH) ? ( buffer == <span class="literal">NULL</span> ? ALLOC_LOCAL : ALLOC_NONE) : ALLOC_CBLK,</span><br><span class="line">                  type),</span><br><span class="line">    <span class="built_in">mSharedBuffer</span>(sharedBuffer),</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到，<code>mSharedBuffer</code>已经成功的放进了<code>AudioFlinger</code>，且通过了<code>PlaybackThread</code>创建线程<code>Track</code>，将其放进了<code>mTracks</code>。</p>
<h2 id="How-To-Play"><a href="#How-To-Play" class="headerlink" title="How To Play"></a>How To Play</h2><p>目前已经跟踪<code>mSharedBuffer</code>初始化的来龙去脉，那么就来看看是怎么播放的了</p>
<blockquote>
<p>frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;Threads.cpp</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">AudioFlinger::MixerThread::<span class="built_in">MixerThread</span>(<span class="type">const</span> sp&lt;AudioFlinger&gt;&amp; audioFlinger, AudioStreamOut* output,</span><br><span class="line">        <span class="type">audio_io_handle_t</span> id, <span class="type">audio_devices_t</span> device, <span class="type">type_t</span> type)</span><br><span class="line">    :   <span class="built_in">PlaybackThread</span>(audioFlinger, output, id, device, type),</span><br><span class="line">&#123;</span><br><span class="line">    mOutputSink = <span class="keyword">new</span> <span class="built_in">AudioStreamOutSink</span>(output-&gt;stream);</span><br><span class="line">    <span class="keyword">if</span> (initFastMixer) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">size_t</span> sinkBufferSize = mNormalFrameCount * mFrameSize;</span><br><span class="line">        (<span class="type">void</span>)<span class="built_in">posix_memalign</span>(&amp;mSinkBuffer, <span class="number">32</span>, sinkBufferSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (kUseFastMixer) &#123;</span><br><span class="line">    <span class="keyword">case</span> FastMixer_Static:</span><br><span class="line">        mNormalSink = initFastMixer ? mPipeSink : mOutputSink;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> AudioFlinger::PlaybackThread::<span class="built_in">threadLoop</span>()</span><br><span class="line">&#123;</span><br><span class="line">            <span class="keyword">if</span> (mMixerBufferValid) &#123;</span><br><span class="line">                <span class="type">void</span> *buffer = mEffectBufferValid ? mEffectBuffer : mSinkBuffer;</span><br><span class="line">                <span class="type">audio_format_t</span> format = mEffectBufferValid ? mEffectBufferFormat : mFormat;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">memcpy_by_audio_format</span>(buffer, format, mMixerBuffer, mMixerBufferFormat,</span><br><span class="line">                        mNormalFrameCount * mChannelCount);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mBytesRemaining) &#123;</span><br><span class="line">                    <span class="type">ssize_t</span> ret = <span class="built_in">threadLoop_write</span>();</span><br><span class="line">                    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        mBytesRemaining = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mBytesWritten += ret;</span><br><span class="line">                        mBytesRemaining -= ret;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> AudioFlinger::PlaybackThread::<span class="built_in">threadLoop_write</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> bytesWritten;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> offset = mCurrentWriteLength - mBytesRemaining;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If an NBAIO sink is present, use it to write the normal mixer&#x27;s submix</span></span><br><span class="line">    <span class="keyword">if</span> (mNormalSink != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> framesWritten = mNormalSink-&gt;<span class="built_in">write</span>((<span class="type">char</span> *)mSinkBuffer + offset, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，在<code>MixerThread</code>构造函数里初始化<code>AudioStreamOutSink</code>赋值给<code>mNormalSink</code>，通过循环<code>threadLoop</code>，调用<code>threadLoop_write</code>写数据。</p>
<p>上面出了一个新的类<code>AudioStreamOutSink</code>，它就是会链接hal层的audio进行播放，具体初始化看下面</p>
<blockquote>
<p>frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;AudioFlinger.cpp</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;AudioFlinger::PlaybackThread&gt; <span class="title">AudioFlinger::openOutput_l</span><span class="params">(<span class="type">audio_module_handle_t</span> <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            <span class="type">audio_io_handle_t</span> *output,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            <span class="type">audio_config_t</span> *config,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            <span class="type">audio_devices_t</span> devices,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            <span class="type">const</span> String8&amp; address,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                            <span class="type">audio_output_flags_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AudioHwDevice *outHwDev = <span class="built_in">findSuitableHwDev_l</span>(<span class="keyword">module</span>, devices);</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> status = hwDevHal-&gt;<span class="built_in">open_output_stream</span>(hwDevHal,</span><br><span class="line">                                                   *output,</span><br><span class="line">                                                   devices,</span><br><span class="line">                                                   flags,</span><br><span class="line">                                                   config,</span><br><span class="line">                                                   &amp;outStream,</span><br><span class="line">                                                   address.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == NO_ERROR &amp;&amp; outStream != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        AudioStreamOut *outputStream = <span class="keyword">new</span> <span class="built_in">AudioStreamOut</span>(outHwDev, outStream, flags);</span><br><span class="line"></span><br><span class="line">            thread = <span class="keyword">new</span> <span class="built_in">MixerThread</span>(<span class="keyword">this</span>, outputStream, *output, devices);</span><br><span class="line"></span><br><span class="line">        mPlaybackThreads.<span class="built_in">add</span>(*output, thread);</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个的<code>findSuitableHwDev_l</code>就是匹配Hardware的Audio，分析请看下一往篇加载HAL，然后通过构建了AudioStreamOut对象，传送给了MixerThread</p>
<p>是不是发现，<strong>这里段播放这一段怎么直接从AudioFlinger开始？，我没找到代码流程如何变换的- -！！，找源码也一头雾水，大家可以frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;Track.cpp和frameworks&#x2F;av&#x2F;services&#x2F;audioflinger&#x2F;Threads.cpp和其它，如果乐意，可以分享给我，非常感谢！</strong></p>
<ul>
<li><a href="http://xuie0000.com/2016/10/24/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93/">Android Audio系统分析总结</a></li>
<li><a href="http://xuie0000.com/2016/10/24/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%E6%A6%82%E8%A7%88/">Android Audio系统分析（一）概览</a></li>
<li><a href="http://xuie0000.com/2016/10/24/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8A%A0%E8%BD%BDHAL/">Android Audio系统分析（二）加载HAL</a></li>
<li><a href="http://xuie0000.com/2016/10/24/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89%E5%86%99%E9%A9%B1%E5%8A%A8/">Android Audio系统分析（三）写驱动</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">二十I邊界</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xuie0000.com/post/2016-10-24-2019/Android-Audio系统分析（一）概览.html">https://xuie0000.com/post/2016-10-24-2019/Android-Audio系统分析（一）概览.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xuie0000.com">二十I邊界</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android-Source/">Android Source</a><a class="post-meta__tags" href="/tags/Android-System/">Android System</a><a class="post-meta__tags" href="/tags/Audio/">Audio</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/post/2016-10-24-2019/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8A%A0%E8%BD%BDHAL.html"><i class="fa fa-chevron-left">  </i><span>Android Audio系统分析（二）加载HAL</span></a></div><div class="next-post pull-right"><a href="/post/2016-10-24-2019/Android-Audio%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93.html"><span>Android Audio系统分析总结</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5f40ac3455a6602d7ceb',
  clientSecret: 'a5e139552df2922935464b9962b851b3f8c90c1d',
  repo: 'xuie0000.github.io',
  owner: 'xuie0000',
  admin: 'xuie0000',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://github.com/xuie0000/xuie0000.github.io/assets/8099426/9f0744ca-d4e6-48f6-91fd-aefec139e021)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2024 By 二十I邊界</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>